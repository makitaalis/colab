# Стандарт интеграции модулей v1

Цель: добавить камеры и железные модули (GPS/RTC/LTE) без поломки уже работающего контура `Edge → Central → Server`.

Связанные документы:

- канон дверей: `Docs/настройка ПО/План/0. Паспорт дверей (door_id ↔ hostname ↔ IP).md`
- базовая архитектура: `Docs/Проект/Архитектура.md`
- протокол edge→central: `Docs/Проект/Протокол (Edge→Central).md`
- контур central→backend: `Docs/Проект/Сервер (Central→Backend).md`

## 1) Базовые принципы

- Контракты важнее реализации: сначала фиксируем поля/интерфейсы, потом код.
- Обратная совместимость: текущие payload и сервисы должны продолжать работать.
- Поэтапное включение: один модуль = отдельный этап + отдельный чек-лист приёмки.
- Любое изменение контракта сопровождается обновлением документации и commissioning-отчётом.

Текущая фаза:

- стабильные транспортные этапы `12.1` и `12.2` уже базово внедрены;
- переходим к `12.3` (камеры), начиная с `central-gw`.

## 2) Контракты (минимум)

### 2.1 Edge событие (камера/подсчёт → Central)

Обязательные поля:

- `schema_ver` (int)
- `node_id` (string)
- `door_id` (int)
- `seq` (int, монотонный на узле)
- `ts` (ISO8601 UTC)
- `in` / `out` (int)

Опционально:

- `confidence`
- `source` (например `oakd-lite-v3`)
- `track_id`, `direction`, `axis`, `line` (для диагностики)

Правило совместимости:

- `schema_ver=1` не удаляем и не меняем семантику существующих полей.
- новые поля добавляем только как опциональные.

### 2.2 Central batch (агрегат остановки → Server)

Обязательные поля:

- `schema_ver`
- `vehicle_id`
- `batch_id` (уникальный, idempotency key)
- `ts_sent`
- `stop.stop_id`
- `stop.method` (`manual|timer|gps` в будущем)
- `doors[]`

Правило:

- `batch_id` уникален и детерминируем по контексту события.
- backend обязан сохранять идемпотентность по `batch_id`.

### 2.3 Heartbeat (Central → Server)

Обязательные поля:

- `central_id`
- `ts_sent`
- `time_sync`
- `services`
- `queue` (включая `stop_mode`)
- `doors` (reachable + freshness)

Правило:

- алерты backend должны учитывать `stop_mode`.

## 3) Порядок интеграции модулей

### 3.0 Камерный baseline по Luxonis (обязательно перед DoD)

Официальные источники:

- `https://docs.luxonis.com/software-v3/depthai/`
- `https://docs.luxonis.com/software-v3/depthai/depthai-components/host_nodes/dynamic_calibration`
- `https://docs.luxonis.com/software-v3/depthai/depthai-components/nodes/object_tracker/`
- `https://docs.luxonis.com/software-v3/depthai/depthai-components/nodes/detection_network/`
- `https://docs.luxonis.com/software-v3/depthai/depthai-components/messages/tracklets/`

Выбранный production baseline v1:

- `DetectionNetwork(person)` + `ObjectTracker` + виртуальная линия;
- гистерезис и минимальный возраст трека для защиты от дребезга;
- depth-only не используется как основной режим (из-за scene-specific hardcoded тюнинга).

Минимальные технические требования:

- `depthai` установлен на узле с камерой;
- есть `udev` правило для USB vendor `03e7`;
- проходит headless smoke (`scripts/oakd_v3_smoke.py`) с чтением кадров.

### 3.1 OAK-D Lite на edge (`door-1`, `door-2`)

Definition of Done:

- edge публикует события в контракте `schema_ver=1`;
- `passengers-edge-sender` стабильно доставляет на Central;
- `scripts/mvp_e2e_smoke.sh` проходит;
- commissioning отчёт без `fail`.

### 3.2 OAK-D Lite на central (`door_id=1`)

Definition of Done:

- `passengers-camera-counter.service` стабильно `active`;
- события двери №1 сохраняются в `central.sqlite3` в контракте `schema_ver=1`;
- агрегация включает все 3 двери;
- backend статистика корректна по каждой двери.

### 3.3 GPS + RTC на central

Definition of Done:

- `time_sync` не деградирует при ребутах без интернета;
- в batch добавляется `stop.method=gps` после включения режима;
- timestamp единый для всех дверей.

### 3.4 LTE (EM7455) uplink на central

Definition of Done:

- основной маршрут наружу через LTE/Wi‑Fi по политике;
- при обрыве uplink данные копятся и догоняются;
- heartbeat показывает состояние связи.

## 4) Управление изменениями

Перед включением нового модуля обязательно:

1. Обновить этот стандарт (если меняется контракт/правило).
2. Обновить операционные шаги в `Docs/Проект/Операции.md`.
3. Обновить проблемные кейсы в `Docs/Проект/Проблемы.md`.
4. Снять commissioning отчёт:
   - `python3 scripts/fleet_commission.py --system-id <SYSTEM_ID> --smoke`

## 5) Текущий рабочий профиль

- `STOP_MODE=manual`
- связь edge→central по Ethernet `192.168.10.0/24`
- связь central→server через WireGuard `10.66.0.0/24`
- backend принимает batch/heartbeat и показывает Fleet мониторинг
