# Протокол обмена данными (Edge → Central)

Рекомендуемый базовый протокол: **HTTP + JSON** (простота, отладка, прозрачность).

## Канон дверей

Перед использованием `door_id` сверяться с:

- `Docs/настройка ПО/План/0. Паспорт дверей (door_id ↔ hostname ↔ IP).md`

## Поток

- `door-1` (дверь №2) → отправляет события на `central-gw`
- `door-2` (дверь №3) → отправляет события на `central-gw`

Транспорт:

- HTTP POST на Central в LAN `192.168.10.0/24`

## Минимальный формат события

```json
{
  "door_id": 2,
  "ts": "2026-01-23T10:15:04.123Z",
  "in": 2,
  "out": 1,
  "confidence": 0.94
}
```

Цель этого слоя — доставить **сырые события** на Central, где они:

- валидируются
- дополняются GPS (если нужно)
- агрегируются (например “пакет на остановку”) и отправляются на backend

См. схему отправки наружу: `Docs/Проект/Сервер (Central→Backend).md`.

Рекомендации для надёжности (желательно добавить сразу):

- `node_id` (UUID узла, из `/etc/node_id`)
- `seq` (монотонный счётчик событий на узле)
- `schema_ver` (версия схемы)

Пример расширенного события:

```json
{
  "schema_ver": 1,
  "node_id": "e6ef5a7d-adf5-46ac-8a94-0366651ab1d7",
  "door_id": 2,
  "seq": 10452,
  "ts": "2026-01-23T10:15:04.123Z",
  "in": 2,
  "out": 1,
  "confidence": 0.94
}
```

## Идемпотентность и повторы

edge‑узел должен уметь повторно отправлять события при ошибках сети.

Минимальная стратегия:

- при `2xx` считать событие доставленным и удалять из локального буфера
- при `5xx`/timeout — ретраить с backoff

Чтобы Central мог дедуплицировать:

- использовать ключ `(node_id, seq)` как уникальный идентификатор события

## Endpoint (предложение)

На Central:

- `POST /api/v1/events` — приём событий
- `GET /health` — статус (time sync, очередь, диски, версия)

HTTP ответ:

- `200 OK` + JSON с результатом приёма
- `400` при невалидном payload
