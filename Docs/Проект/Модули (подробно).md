# Модули (логические компоненты)

Этот документ фиксирует “что за процессы/сервисы” нужны в системе. Реализация может быть Python/systemd, важно — **ответственность и границы**.

## Edge (на `door-1`, `door-2`)

- **`passenger-counter`**: захват данных с OAK‑D Lite, подсчёт вход/выход.
- **`uploader-to-central`**: доставка событий на `central-gw` (ретраи, backoff).
- **`local-buffer`**: очередь/буфер при потере связи с Central (файл/SQLite).
- **`health`**: минимальный статус (время синхронизировано, очередь, температура/аптайм).

### MVP (без камеры, для обкатки контура)

- `passengers-edge-sender` — отправка очереди событий (SQLite) на Central по HTTP.
- Локальный буфер: `/var/lib/passengers/edge.sqlite3` (таблица `outbox`).
- `preflight.py` (ExecStartPre) — гейт запуска: время синхронизировано + Central health доступен.

## Central (на `central-gw`)

- **`passenger-counter-door1`**: подсчёт для двери №1 (камера подключена к Central).
- **`collector`**: приём событий от `door-1`/`door-2` (HTTP endpoint/другой транспорт).
- **`aggregator`**: агрегация по двери/времени/рейсу.
- **`uplink`**: отправка наружу по LTE + буферизация при потере интернета.
- **`time-master`**: локальный NTP сервер (chrony) + health.

### MVP (без GPS/RTC, для обкатки контура)

- `passengers-collector` — HTTP endpoint `POST /api/v1/edge/events` + SQLite (idempotency по `(node_id, seq)`).
- `central_flush.py` — агрегация и отправка агрегатов на backend (ручной или таймерный запуск).
- `passengers-central-flush.timer` — автоматический запуск `central_flush.py` при `STOP_MODE=timer`.
- `central_heartbeat.py` — снимок состояния Central (systemd/очередь/двери) и отправка на backend.
- `passengers-central-heartbeat.timer` — периодический heartbeat на backend (контроль “alive”).
- `service_watchdog.py` — watchdog-проверка критичных юнитов и авто-восстановление по роли узла.
- `passengers-service-watchdog.timer` — запуск watchdog-проверки каждые ~45 секунд.
- `preflight.py` (ExecStartPre) — гейт запуска: время синхронизировано + backend health по VPN доступен для uplink.

## Backend (сервер)

- `POST /api/v1/ingest/stops` — приём агрегатов “остановок” от Central.
- `POST /api/v1/ingest/central-heartbeat` — приём heartbeat от Central (состояние сервисов/очереди/дверей).
- `GET /api/admin/fleet/centrals` — API для админки: список Centrals и их последний heartbeat.
- `GET /api/admin/fleet/overview` — агрегированная сводка по fleet (totals + top alerts), опция `include_centrals=1`.
- `GET /api/admin/fleet/alerts` — плоская лента алертов с фильтрами `severity`, `include_silenced`, `central_id`, `code`, `q`.
- `GET /api/admin/fleet/monitor` — единый snapshot для dashboard (`fleet/incidents/notifications/security/attention`) на окно `window`.
- `GET /api/admin/fleet/health` — облегчённый health snapshot для внешнего мониторинга/алертов.
- `POST /api/admin/fleet/health/notify-test` — ручной fleet-health test alert (каналы `telegram/email`, поддержка `dry_run`).
- `POST /api/admin/fleet/health/notify-auto` — авто-оценка fleet health и отправка alert по политике (state-change + rate-limit + recovery).
- `GET /api/admin/fleet/monitor-policy` — чтение monitor policy thresholds.
- `POST /api/admin/fleet/monitor-policy` — обновление monitor policy thresholds.
- `GET /api/admin/fleet/monitor-policy/overrides` — список per-central monitor overrides.
- `POST /api/admin/fleet/monitor-policy/overrides` — upsert override по `central_id`.
- `DELETE /api/admin/fleet/monitor-policy/overrides/{central_id}` — удалить override.
- `GET /api/admin/fleet/incidents` — слой инцидентов (`open/acked/silenced/resolved`) + SLA-поля (`age_sec`, `sla_target_sec`, `sla_breached`).
- `GET /api/admin/fleet/incidents/{central_id}/{code}` — incident detail (состояние + timeline: history/actions/notifications).
- `POST /api/admin/fleet/incidents/sync` — ручной пересчёт incidents из текущих heartbeat/alerts.
- `GET /api/admin/fleet/incidents/notifications` — лог отправки уведомлений по incidents (`telegram/email`, `sent/failed/skipped`).
- `GET /api/admin/fleet/metrics/history` — bucketed история KPI по fleet + уведомления + alert actions.
- `GET /api/admin/whoami` — информация о текущем admin token (`actor`, `role`, `capabilities`).
- `GET /api/admin/audit` — аудит admin API операций (доступно только роли `admin`).
- `GET /api/admin/fleet/notification-settings` — текущие policy-правила уведомлений.
- `POST /api/admin/fleet/notification-settings` — обновление policy-правил уведомлений.
- `POST /api/admin/fleet/notification-settings/test` — ручная тестовая отправка уведомления (с выбором `channel` и `dry_run`).
- `POST /api/admin/fleet/notifications/retry` — ручной retry конкретной записи доставки (`notification_id`).
- `GET /api/admin/fleet/central/{central_id}` — текущий срез + история heartbeat по конкретному Central.
- `GET /api/admin/fleet/alerts/actions` — журнал действий админа по алертам (фильтры `central_id`, `code`, `action`, `q`).
- `POST /api/admin/fleet/alerts/ack` — ack алерта (`central_id`, `code`).
- `POST /api/admin/fleet/alerts/silence` — приглушить алерт на `duration_sec`.
- `POST /api/admin/fleet/alerts/unsilence` — снять приглушение.
- `GET /api/admin/fleet/alerts/state/{central_id}/{code}` — текущее состояние alert-state.
- `GET /api/admin/fleet/centrals` также возвращает:
  - `health` (`severity`, `alerts_total`, `alerts_all_total`, `alerts_silenced`, `alerts_warn`, `alerts_bad`)
  - `alerts[]` (коды и сообщения проблем по Central + флаги `acked/silenced`)
- `/admin` — dashboard c unified monitor-срезом (`/api/admin/fleet/monitor`), KPI + `Needs action` + активные алерты (auto-refresh).
- `/admin/fleet` — web‑страница мониторинга fleet (severity filter, summary counters, alert stream).
- `/admin/fleet/incidents` — web‑страница incidents + SLA + лог доставки уведомлений.
- `/admin/fleet/incidents` также содержит KPI (`Open/Bad/Warn/SLA breach`) и фильтр `SLA breach only`.
- `/admin/fleet/incidents/{central_id}/{code}` — web‑страница incident detail (карточка + timeline + actions).
- `/admin/fleet/notifications` — web‑страница настройки policy-правил уведомлений + `Send test notification`.
- `/admin/fleet/policy` — web‑страница monitor policy (пороги `heartbeat/pending/wg` для dashboard/health API).
- `/admin/fleet/policy` также включает policy авто-алертов fleet health и кнопки `Auto now` (роль `operator+`).
- `/admin/fleet/policy` также включает раздел `Per-central overrides` (CRUD override по `central_id`).
- `/admin/fleet/history` — web‑страница трендов KPI/уведомлений по bucket.
- `/admin/fleet/notify-center` — web‑страница delivery log + manual retry failed уведомлений.
- `/admin/audit` — web‑страница аудита admin операций и попыток `forbidden`.
- `/admin/fleet/central/{central_id}` — drill-down страница по одному Central (текущий срез + история + alert actions + action log).
- `/admin/fleet/actions` — глобальный журнал действий по алертам с фильтрами и переходами в central drill-down.
- `/admin/wg` — web‑страница WireGuard peers.

RBAC для admin API:

- `viewer`: чтение (`GET`) мониторинга/статуса.
- `operator`: действия эксплуатации (`ack/silence/unsilence`, `test/retry`, `incidents/sync`).
- `admin`: управление policy и просмотр audit.

Role-aware UI:

- на страницах `fleet`, `central detail`, `incident detail` операционные кнопки отключаются для `viewer`
- на странице `notification rules` кнопки `Save/Clear` доступны только `admin`, `Send test` — `operator+`
- на странице `notify-center` кнопка `Retry` доступна только `operator+`

## Системные модули

- **Сеть**: NetworkManager, статический IP, firewall (`nftables`).
- **Время**: chrony/timesyncd + проверки.
- **Логи**: journald/logrotate (важно не ломать journal при ramlog).

## Операционный модуль проверки

- `scripts/mvp_e2e_smoke.sh` — автоматический контрольный прогон всего MVP контура (Door→Central→Backend) с проверкой дельты в backend.
- `scripts/fleet_registry.py` — реестр и масштабирование rollout (валидация, выдача следующего WG IP, генерация per-system bundle).
- `scripts/fleet_apply_wg_peer.py` — idempotent применение WG peer блока на сервере.
- `scripts/fleet_apply_central_env.py` — sync конфигурации `passengers.env` на Central из bundle.
- `scripts/fleet_rollout.sh` — оркестратор rollout для одной системы.
- `scripts/fleet_rollout_check.py` — генерация rollout-check отчётов (без железа) для `system_id`/диапазона.
- `scripts/fleet_commission.py` — стандартизованный commissioning-check + отчёт в `Docs/auto/commissioning/`.
- `scripts/test_edge_central_resilience.sh` — тест этапа 12.1 (имитация потери связи Edge→Central и проверка догонки очереди).
- `scripts/test_central_server_resilience.sh` — тест этапа 12.2 (имитация потери связи Central→Server/WireGuard и проверка догонки batch).
- `scripts/test_central_server_controlled_offline.sh` — длительный controlled-offline тест `12.2` (30–60 минут) с накоплением `pending` и проверкой полной догонки после восстановления WG.
- `scripts/fleet_scale_dry_run.py` — dry-run масштабирования реестра до целевого числа систем с автоотчётом и симуляционным CSV.
- `scripts/fleet_batch_template.py` — генерация шаблонного пакета `sys-0002..sys-0020` для ручного ввода.
- `scripts/fleet_api_keys.py` — per-system ключи API (`ensure/rotate/revoke/sync-server`).
- `scripts/install_server_db_backup.sh` — установка backup timer БД backend на сервере.
- `scripts/install_server_fleet_health_auto.sh` — установка timer авто-алертов fleet health на сервере.
- `scripts/server_db_restore_check.sh` — проверка восстановления из последнего бэкапа.
- `scripts/install_server_admin_hardening.sh` — применение nginx/fail2ban hardening для публичной админки.
- `mvp/queue_maintainer.py` — ретеншн/лимиты очередей Edge/Central по таймеру (включая `pending` batch лимиты на Central).
- `scripts/install_opi_watchdog.sh` — установка watchdog baseline на OPi (systemd RuntimeWatchdogSec + service watchdog timer).
- `mvp/service_watchdog.py` — проверка/восстановление `passengers-*`, `wg-quick@wg0` и таймеров по роли узла.
