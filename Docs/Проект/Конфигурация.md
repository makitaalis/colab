# Конфигурация (что задаётся вручную)

Этот документ фиксирует параметры, которые задаются руками (чтобы одинаково настраивать все ТС).

## `vehicle_id`

Идентификатор транспортного средства задаётся **вручную на `central-gw`**.

Требования:

- уникальный в рамках backend
- стабильный (не менять при каждом ребуте/обновлении)

Примеры:

- `bus-017_AA1234BB`
- `tram-03_CC5678DD`
- `vehicle-0001_XX0000XX`

Где используется:

- в payload, который `central-gw` отправляет на backend (`Docs/Проект/Сервер (Central→Backend).md`)
- может дублироваться в заголовке `X-Vehicle-Id` (опционально)

## Формат `vehicle_id` (выбранный для проекта)

Для проекта выбран **склеенный** формат: **`bus-017` + `_` + госномер**.

Пример:

`bus-017_AA1234BB`

Правила:

- разделитель: `_` (один underscore)
- госномер: без пробелов, в верхнем регистре (пример: `AA1234BB`)
- избегать спецсимволов (`/`, пробелы, `?`, `&`) — `vehicle_id` часто используется в логах/URL/ключах

⚠️ Важное следствие: если поменяется госномер, поменяется и `vehicle_id`, а значит статистика на backend должна либо:

- поддерживать “переименование” (mapping old→new), либо
- считать это новым ТС.

Если вы хотите избежать этого эффекта — вернитесь к варианту “2 поля” (`vehicle_id` + `vehicle_plate`) и храните госномер отдельно.

## Где хранить на `central-gw` (рекомендация)

Чтобы не “размазывать” параметры по разным местам, удобно завести единый файл окружения для systemd:

 - `/etc/passengers/passengers.env` (рекомендуется `root:orangepi`, `0640`)

⚠️ Важно: сейчас сервисы запускаются от пользователя `orangepi` и читают `EnvironmentFile=/etc/passengers/passengers.env`,
поэтому файл должен быть **читаемым для `orangepi`**, иначе сервисы будут падать с `PermissionError`.

Рекомендуемые права:

- owner/group: `root:orangepi`
- mode: `0640`

Пример:

```bash
VEHICLE_ID=bus-017_AA1234BB
BACKEND_URL=http://10.66.0.1/api/v1/ingest/stops
BACKEND_API_KEY=__PUT_REAL_KEY_HERE__
STOP_MODE=manual
STOP_FLUSH_INTERVAL_SEC=120
```

### Режим “остановки” (`STOP_MODE`)

- `STOP_MODE=manual` — пакеты отправляются вручную командой `central_flush.py --send-now`.
- `STOP_MODE=timer` — включается `passengers-central-flush.timer` и пакеты формируются автоматически.

Текущее решение для раннего этапа проекта: `STOP_MODE=manual`.

`STOP_FLUSH_INTERVAL_SEC` используется при `STOP_MODE=timer` как интервал автосброса.

В тесте используем `http://...`, переход на `https://...` — отдельным шагом после появления домена/решения по TLS.

Дальше systemd-unit’ы могут использовать:

`EnvironmentFile=/etc/passengers/passengers.env`

## Edge-узлы (`door-1`, `door-2`) — минимальная конфигурация (MVP)

Для MVP контура Edge→Central используется тот же файл:

- `/etc/passengers/passengers.env` (права `root:orangepi`, `0640`)

Минимально:

```bash
NODE_ID=door-1
DOOR_ID=2
CENTRAL_URL=http://192.168.10.1:8080/api/v1/edge/events
```

Если включён Wi‑Fi fallback Door↔Central, `CENTRAL_URL` можно задать списком (через запятую) — sender попробует по порядку:

```bash
CENTRAL_URL=http://192.168.10.1:8080/api/v1/edge/events,http://192.168.20.1:8080/api/v1/edge/events
```

Опционально (для более быстрого переключения при “упавшем” первом URL) можно настроить короткий cooldown:

```bash
CENTRAL_URL_COOLDOWN_SEC=5
```
