# Домен Клієнт

## Назначение

Клиентский кабинет: статусы, транспорт, обращения, профиль.

## Route scope (MVP step-2)

- `/client`
- `/client/vehicles`
- `/client/tickets`
- `/client/status`
- `/client/profile`
- `/client/notifications`

## API scope (MVP step-2)

- `/api/client/whoami`
- `/api/client/home`
- `/api/client/vehicles`
- `/api/client/tickets`
- `/api/client/status`
- `/api/client/profile` (`GET/POST`)
- `/api/client/notification-settings` (`GET/POST`)

Примечание: на этапе MVP step-2 клиентские страницы переведены с mock/localStorage на backend API.

## Auth-контур домена

1. Защита на nginx:
- `/client*` и `/api/client/*` доступны только под BasicAuth.
2. Проксирование auth в backend:
- nginx подставляет `Authorization: Bearer $passengers_client_api_token` для `/api/client/*`;
- actor клиента передаётся в header `X-Client-User`.
3. Backend-валидация:
- `CLIENT_API_KEYS` (fallback: `ADMIN_API_KEYS` -> `PASSENGERS_API_KEYS`);
- scope клиента задаётся через `CLIENT_SCOPE_BINDINGS` или default `CLIENT_DEFAULT_*`.
- роль `admin-support` задаётся через `CLIENT_SUPPORT_USERS`.

## UX-контракт домена

1. Минимальная когнитивная нагрузка:
- крупные статусы;
- короткие тексты;
- без операторских технических деталей.
2. Прозрачность:
- что происходит сейчас;
- что ожидается от клиента;
- как быстро связаться с поддержкой.

## Ограничения

- без admin-терминологии (`policy`, `ack/silence`, `triage`);
- без операционных debug-инструментов.

## Definition of Done (для запуска client MVP)

1. Отдельный client shell и nav на базе `client_core/client_domains`.
2. Базовые страницы `Огляд`, `Мої транспорти`, `Тікети`, `Профіль`.
3. Единый UI-ритм с admin-панелью, но меньшая плотность данных.

## Прогресс Client MVP step-1 (2026-02-16)

- Запущен отдельный клиентский shell:
  - `backend/app/client_ui_kit.py`.
- Добавлены клиентские page-модули:
  - `client_home_page.py`, `client_vehicles_page.py`, `client_tickets_page.py`,
  - `client_status_page.py`, `client_profile_page.py`, `client_notifications_page.py`.
- Включены route в backend:
  - `main.py` (`/client*`).
- Доменная карта клиента синхронизирована с page-file:
  - `backend/app/client_domains/domain_catalog.py`.
- Server-first доступ:
  - `https://207.180.213.225:8443/client*` доступны под BasicAuth (через nginx location `/client`).

## Прогресс Client MVP step-2 (2026-02-16)

- Добавлен клиентский backend-слой:
  - `backend/app/client_ops.py` (home/vehicles/tickets/status/profile/notification-settings).
- В backend добавлены route:
  - `/api/client/whoami`
  - `/api/client/home`
  - `/api/client/vehicles`
  - `/api/client/tickets`
  - `/api/client/status`
  - `/api/client/profile` (`GET/POST`)
  - `/api/client/notification-settings` (`GET/POST`)
- В БД добавлены таблицы:
  - `client_profiles`
  - `client_notification_settings`
- Клиентские страницы переведены на API:
  - `client_home_page.py`, `client_vehicles_page.py`, `client_tickets_page.py`,
  - `client_status_page.py`, `client_profile_page.py`, `client_notifications_page.py`.
- Server-first rollout:
  - nginx: добавлен `location ^~ /api/client/` + Bearer proxy;
  - smoke-gate расширен `/api/client/*` и проходит PASS.

## Прогресс Client MVP step-3 (2026-02-16)

- В client core внедрён единый secondary-паттерн:
  - `<details class="secondaryDetails">` + хранение state в `localStorage` через `ClientUiKit.bindDetailsState(...)`.
- Страница `Тікети` разнесена по сценариям:
  - primary: `Активні звернення`;
  - secondary: `Архів вирішених звернень` (свернуто по умолчанию).
- Страница `Статуси` разнесена по сценариям:
  - primary: `Потребує уваги зараз` (warn/bad);
  - secondary: `Повна стрічка статусів` (свернуто по умолчанию).
- Для `Тікети` и `Статуси` сохранены shareable URL фильтров (`q`, `level`) и `copyLink`.
- Server-first rollout:
  - deploy на VPS + `py_compile` + `docker compose ... --build api`;
  - `scripts/admin_panel_smoke_gate.sh` = PASS.

## Прогресс Client MVP step-4 (2026-02-16)

- Ролевой контур клиента:
  - `/api/client/whoami` теперь возвращает `role` (`client` | `admin-support`);
  - роль вычисляется по env `CLIENT_SUPPORT_USERS`.
- UX роль-подачи:
  - на `Огляд`, `Тікети`, `Статуси` добавлен role-chip (`роль: client/admin-support`);
  - для `admin-support` secondary-блоки на `Тікети/Статуси` по умолчанию раскрываются.
- Mobile-tuning:
  - таблицы `Тікети/Статуси` переведены на `mobileFriendly`;
  - вторичные колонки скрываются на узком экране (`mobileHide`);
  - toolbar-контролы на mobile идут в one-column поток.
- Server-first rollout:
  - deploy на VPS + `py_compile` + `docker compose ... --build api`;
  - `scripts/admin_panel_smoke_gate.sh` = PASS.

## Прогресс Client MVP step-5 (2026-02-16)

- SLA/ETA сценарии в backend:
  - `backend/app/client_ops.py`:
    - добавлены SLA/ETA helpers (`_estimate_eta_delay_min`, `_resolve_sla_state`, `_to_int`);
    - `home` теперь возвращает `summary.sla_*`, `summary.eta_*` и `attention`;
    - `vehicles` возвращает расширенный срез (`sla_state`, `eta_delay_min`, `pending_batches`, `incidents_open`) и SLA/ETA summary.
- `Огляд` (`client_home_page.py`) перестроен под SLA/ETA:
  - добавлены KPI-бейджи `SLA` и `ETA`;
  - добавлен primary-блок `Потребує дії зараз` с короткими CTA-подсказками.
- `Мої транспорти` (`client_vehicles_page.py`) разнесены по `primary + secondary`:
  - primary: `Потребують уваги` (SLA/ETA фокус);
  - secondary: `Усі транспорти` в `<details>` с persisted-state;
  - добавлен фильтр `sla=all|attention|risk|warn|ok`, role-chip и mobile-first таблицы.
- Server-first rollout:
  - deploy на VPS + `py_compile` + `docker compose ... --build api` — OK;
  - `scripts/admin_panel_smoke_gate.sh` — PASS.

## Прогресс Client MVP step-6 (2026-02-16)

- `Профіль` (`backend/app/client_profile_page.py`) переведён на role-aware сценарий:
  - добавлен role-chip и summary-контур (`ПРОФІЛЬ/КОНТАКТ/МОВА`);
  - `secondary` блок `Деталі для підтримки` (`<details>` + persisted state);
  - добавлен безопасный reset к последней сохранённой версии (без destructive-очистки).
- `Сповіщення` (`backend/app/client_notifications_page.py`) переведены на role-aware сценарий:
  - добавлен role-chip и summary-контур (`КАНАЛИ/ПРІОРИТЕТ/ДАЙДЖЕСТ`);
  - quick presets (`critical/balanced/realtime`) для быстрых клиентских сценариев;
  - `secondary` блок `Деталі для підтримки` (`<details>` + persisted state).
- E2E runbook для client-account контура:
  - проверяются `/client/profile`, `/client/notifications`,
    `/api/client/profile`, `/api/client/notification-settings` в server-first цикле.
- Server-first rollout:
  - deploy на VPS + `py_compile` + `docker compose ... --build api` — OK;
  - `scripts/admin_panel_smoke_gate.sh` — PASS.

## Прогресс Client MVP step-7a (2026-02-16)

- Добавлен автоматизированный regression gate:
  - `scripts/client_panel_regression_check.sh`.
- Проверки:
  - `auth=200 / anon=401` для `/client/profile`, `/client/notifications`,
    `/api/client/profile`, `/api/client/notification-settings`;
  - marker-check role-aware элементов account-страниц.
- Результат:
  - `./scripts/client_panel_regression_check.sh --admin-pass-file "pass admin panel"` — `RESULT: PASS`.

## Прогресс Client MVP step-7b (2026-02-16)

- Выполнен финальный real-data UX-аудит:
  - `scripts/client_panel_step7b_audit.py`.
- Сформирован автоматический отчёт:
  - `Docs/auto/web-panel/client-step7b-ux-audit.md`.
- Покрытие аудита:
  - auth/anon (`200/401`) по всему client route/API-контуру;
  - contract-check для `whoami/home/vehicles/profile/notification-settings`;
  - marker-check role-aware account UX на `Профіль/Сповіщення`.
- Результат:
  - `python3 scripts/client_panel_step7b_audit.py --admin-pass-file "pass admin panel"` — `RESULT: PASS`.

## Прогресс Client MVP step-8b (2026-02-16)

- Выполнен acceptance-run режима `admin-support` на сервере:
  - временно включён `CLIENT_SUPPORT_USERS=admin`;
  - подтверждено `/api/client/whoami` -> `role=admin-support`, `support_console=true`.
- Проверки в support-режиме:
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh` — PASS;
  - `scripts/client_panel_step7b_audit.py` — PASS.
- Выполнен rollback:
  - восстановлен исходный `.env`;
  - подтверждено `/api/client/whoami` -> `role=client`;
  - повторный `scripts/admin_panel_smoke_gate.sh` — PASS.
- Артефакт acceptance:
  - `Docs/auto/web-panel/client-step8b-support-acceptance.md`.

## Прогресс Client MVP step-9 (2026-02-16)

- Выполнен постоянный rollout support-логина:
  - `scripts/client_support_rollout.sh`.
- Разделены auth-файлы nginx:
  - `/client*` и `/api/client/*` -> `/etc/nginx/passengers-client.htpasswd`;
  - `/admin*` и `/api/admin/*` -> `/etc/nginx/passengers-admin.htpasswd`.
- Server policy:
  - `CLIENT_SUPPORT_USERS=support`.
- Проверки:
  - `support` -> `/api/client/whoami`: `role=admin-support`;
  - `support` -> `/api/admin/whoami`: `401`;
  - `admin` -> `/api/client/whoami`: `role=client`;
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh` (admin/support) — PASS;
  - `scripts/client_panel_step7b_audit.py` (support) — PASS.
- Артефакт rollout:
  - `Docs/auto/web-panel/client-step9-support-rollout.md`.

## Прогресс Client MVP step-10 (2026-02-16)

- Включена scope-изоляция support-доступа:
  - `scripts/client_scope_rollout.sh`.
- Server policy:
  - `CLIENT_SCOPE_BINDINGS=support:sys-0001`.
- Проверки:
  - `support` -> `/api/client/whoami` возвращает `scope.central_ids=["sys-0001"]`;
  - `support` -> `/api/client/vehicles` видит только scoped данные (`total=1`);
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh --admin-user support ...` — PASS;
  - `scripts/client_panel_step7b_audit.py --admin-user support ...` — PASS.
- Артефакт scope-rollout:
  - `Docs/auto/web-panel/client-step10-scope-rollout.md`.

## Прогресс Client MVP step-11 (2026-02-16)

- Введён policy-шаблон multi-support onboarding:
  - actor naming: `support-<system_id>`;
  - onboarding matrix: `actor|password_file|scope_entries`.
- Добавлен rollout script:
  - `scripts/client_support_matrix_rollout.sh`.
- Добавлен template:
  - `Docs/Проект/Операции/client-support-onboarding-matrix.example`.
- Server rollout:
  - применён actor `support-sys-0001`;
  - `CLIENT_SUPPORT_USERS=support-sys-0001`;
  - `CLIENT_SCOPE_BINDINGS=support-sys-0001:sys-0001`;
  - legacy `support` удалён из `passengers-client.htpasswd`.
- Проверки:
  - `support-sys-0001` -> `/api/client/whoami`: `role=admin-support`, `scope.central_ids=["sys-0001"]`;
  - `support-sys-0001` -> `/api/admin/whoami`: `401`;
  - `admin` -> `/api/client/whoami`: `role=client`;
  - `scripts/client_panel_regression_check.sh` (admin/support-sys-0001) — PASS;
  - `scripts/client_panel_step7b_audit.py` (support-sys-0001) — PASS;
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/server_security_posture_check.sh` — PASS.
- Артефакты:
  - `Docs/auto/web-panel/client-step11-multi-support-onboarding.md`;
  - `Docs/auto/web-panel/client-step7b-ux-audit-support-sys-0001.md`.
- Следующий подэтап:
  - `Client MVP step-12` — lifecycle policy `disable/rotate/revoke` для support-акторов.

## Прогресс Client MVP step-12 (2026-02-16)

- Добавлен lifecycle rollout script:
  - `scripts/client_support_lifecycle_rollout.sh`.
- Выполнен controlled scenario без влияния на основной actor:
  - временно добавлен `support-sys-0099` через matrix rollout;
  - выполнен `rotate` (`support-sys-0099`): старый пароль -> `401`, новый -> `200`;
  - выполнен `disable` (`support-sys-0099`): actor удалён из `CLIENT_SUPPORT_USERS` и client htpasswd;
  - выполнен `revoke` (`support-sys-0099`): actor удалён из `CLIENT_SCOPE_BINDINGS`.
- Финальное server state:
  - `CLIENT_SUPPORT_USERS=support-sys-0001`;
  - `CLIENT_SCOPE_BINDINGS=support-sys-0001:sys-0001`;
  - `support-sys-0001` остаётся `admin-support`.
- Проверки:
  - `scripts/client_support_lifecycle_rollout.sh` (`rotate/disable/revoke`) — PASS;
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/client_panel_step7b_audit.py --admin-user support-sys-0001 ...` — PASS;
  - `scripts/server_security_posture_check.sh` — PASS.
- Артефакты:
  - `Docs/auto/web-panel/client-step12-support-lifecycle-rollout.md`;
  - `Docs/auto/web-panel/client-step7b-ux-audit-support-sys-0001-step12.md`.
- Следующий подэтап:
  - `Client MVP step-13` — lifecycle automation pack (scheduled rotation + actor inventory report).

## Прогресс Client MVP step-13 (2026-02-16)

- Добавлен automation pack:
  - `scripts/client_support_rotation_batch.sh`;
  - `scripts/client_support_inventory_report.sh`;
  - `scripts/install_client_support_lifecycle_timer.sh`.
- Выполнен реальный batch rotate для `support-sys-0001`:
  - old password -> `401`;
  - new password -> `200`;
  - server state сохранил `CLIENT_SUPPORT_USERS=support-sys-0001`.
- На сервере включены timers:
  - `passengers-client-support-inventory.timer` (daily);
  - `passengers-client-support-rotation-reminder.timer` (monthly).
- Проверки:
  - `scripts/client_support_rotation_batch.sh` — PASS;
  - `scripts/client_support_inventory_report.sh` (`status=PASS`) — PASS;
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/client_panel_step7b_audit.py --admin-user support-sys-0001 ...` — PASS;
  - `scripts/server_security_posture_check.sh` — PASS.
- Артефакты:
  - `Docs/auto/web-panel/client-step13-lifecycle-automation-pack.md`;
  - `Docs/auto/web-panel/client-support-inventory-latest.md`;
  - `Docs/auto/web-panel/client-step7b-ux-audit-support-sys-0001-step13.md`.
- Следующий подэтап:
  - `Client MVP step-14` — UX polish client navigation (compact + progressive disclosure on account/tables).

## Прогресс Client MVP step-14 (2026-02-16)

- Выполнен UX-polish shell и навигации:
  - в `client_ui_kit` добавлен compact sidebar (`passengers_client_sidebar_compact_v1`);
  - группы sidebar переведены в `<details>` с persistent state (`passengers_client_sidebar_group_<group>_v1`);
  - сохранён принцип IA `меню -> подменю` и контекстный `page subnav`.
- Выполнен progressive disclosure таблиц:
  - добавлен global toggle `Колонки: базово/детально` (`passengers_client_tables_progressive_v1`);
  - secondary-колонки на `Огляд/Мої транспорти/Тікети/Статуси` маркированы `progressiveCol`.
- Server-first validation:
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/client_panel_step7b_audit.py --admin-user support-sys-0001 ...` — PASS;
  - `scripts/server_security_posture_check.sh` — PASS.
- Артефакты:
  - `Docs/auto/web-panel/client-step14-ux-polish-rollout.md`;
  - `Docs/auto/web-panel/client-step7b-ux-audit-support-sys-0001-step14.md`.
- Следующий подэтап:
  - `Client MVP step-15` — accessibility/keyboard flow + финальный copy-audit без изменения API-контрактов.

## Прогресс Client MVP step-15 (2026-02-16)

- Выполнен accessibility baseline:
  - `skip-link` до основного контента;
  - `focus-visible` контур для keyboard-навигации;
  - `aria-live` для status-подсказок shell.
- Выполнен keyboard flow client shell:
  - `/` (focus search), `Esc` (blur), `Alt+Shift+M` (compact), `Alt+Shift+K` (columns),
    `Alt+Shift+S` (focus sidebar), `Alt+Shift+T` (focus toolbar).
- Выполнен copy-audit account-поддомена:
  - `Профіль`: локализованы support labels и summary;
  - `Сповіщення`: локализованы preset/summary/filter формулировки.
- Обновлён regression/audit контракт:
  - marker-check включает `skipLink`, `sideCompactToggle`, `clientMainContent`.
- Server-first validation:
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/client_panel_step7b_audit.py --admin-user support-sys-0001 ...` — PASS;
  - `scripts/server_security_posture_check.sh` — PASS.
- Артефакты:
  - `Docs/auto/web-panel/client-step15-a11y-keyboard-copy-rollout.md`;
  - `Docs/auto/web-panel/client-step7b-ux-audit-support-sys-0001-step15.md`.
- Следующий подэтап:
  - `Client MVP step-16` — accessibility-acceptance (keyboard-only сценарии) и финальная фиксация DoD.

## Прогресс Client MVP step-16 (2026-02-16)

- Выполнен operator acceptance keyboard-only сценария:
  - `scripts/client_panel_step16_accessibility_check.sh`.
- Проверено:
  - shell markers: `skipLink`, `sideCompactToggle`, `clientMainContent`;
  - keyboard shortcuts: `/`, `Esc`, `Alt+Shift+M/K/S/T`;
  - role `admin-support` + account copy markers (`Профіль/Сповіщення`).
- Server-first validation:
  - `scripts/client_panel_step16_accessibility_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/client_panel_step7b_audit.py --admin-user support-sys-0001 ...` — PASS;
  - `scripts/server_security_posture_check.sh` — PASS.
- Артефакты:
  - `Docs/auto/web-panel/client-step16-accessibility-acceptance.md`;
  - `Docs/auto/web-panel/client-step7b-ux-audit-support-sys-0001-step16.md`.
- Следующий подэтап:
  - `Client MVP step-17` — release-candidate stabilization и финальный handoff checklist.

## Прогресс Client MVP step-17 (2026-02-16, kickoff)

- Зафиксирован IA freeze client-меню:
  - `Docs/Проект/Веб-панель/Архитектура меню (admin+client).md`.
- Preflight playbook дополнен обязательным keyboard-only acceptance:
  - `scripts/client_panel_step16_accessibility_check.sh --admin-user support-sys-0001 ...`.
- Контрольный прогон server-first:
  - `scripts/admin_panel_smoke_gate.sh` — PASS;
  - `scripts/client_panel_regression_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/client_panel_step7b_audit.py --admin-user support-sys-0001 ...` — PASS;
  - `scripts/client_panel_step16_accessibility_check.sh --admin-user support-sys-0001 ...` — PASS;
  - `scripts/server_security_posture_check.sh` — PASS.
- Артефакт kickoff:
  - `Docs/auto/web-panel/client-step17-rc-kickoff.md`.
- Выполнен финальный handoff checklist:
  - добавлен `scripts/client_panel_step17_handoff_check.sh`;
  - отчёт `Docs/auto/web-panel/client-step17-handoff-checklist.md` — PASS;
  - support audit обновлён: `Docs/auto/web-panel/client-step7b-ux-audit-support-sys-0001-step17.md`.
- Следующий подэтап:
  - `Client MVP step-18` — инкрементальный content-split по IA freeze и visual-density аудит.
