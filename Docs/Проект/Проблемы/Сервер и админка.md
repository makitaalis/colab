# Сервер и админка

## Типовые сбои

- Белый экран в `/admin` или `/admin/fleet`.
- `502 Bad Gateway` на `/admin` (nginx upstream connection refused).
- `500` на `/admin/fleet/notifications` или `/admin/fleet/notify-center`.
- После деплоя новый route/API не появился.

## Базовые проверки

```bash
./scripts/admin_panel_smoke_gate.sh --server-host 207.180.213.225 --server-user alis --admin-user admin --admin-pass-file "pass admin panel"
# (или явно) ./scripts/admin_panel_smoke_gate.sh ... --admin-pass "<BASIC_AUTH_PASS>"
ssh alis@207.180.213.225 'cd /opt/passengers-backend && sudo docker compose -f compose.yaml -f compose.server.yaml logs --tail=300 api'
ssh alis@207.180.213.225 'sudo systemctl status passengers-backend.service passengers-wg-export.timer --no-pager'
```

## `502 Bad Gateway` сразу после деплоя

Признак:

- `curl -k https://127.0.0.1:8443/api/admin/whoami` возвращает `502`, а в `/var/log/nginx/error.log` есть `connect() failed (111: Connection refused) ... upstream: "http://10.66.0.1:80/..."`.

Причина:

- backend поднят без server-overlay compose-файла, поэтому нет port mapping `10.66.0.1:80 -> 8000`.

Фикс:

```bash
ssh alis@207.180.213.225 'cd /opt/passengers-backend && sudo docker compose -f compose.yaml -f compose.server.yaml up -d --build api'
ssh alis@207.180.213.225 'curl -k -u admin:<pass> -s -o /dev/null -w \"%{http_code}\\n\" https://127.0.0.1:8443/api/admin/whoami'
```

Профилактика (чтобы админка не уходила в “белый экран” после reboot/ручных операций):

```bash
./scripts/install_server_backend_service.sh --server-host 207.180.213.225 --server-user alis
./scripts/install_server_wg_exporter.sh --server-host 207.180.213.225 --server-user alis
```

## Источник подробных решений

- `Docs/Проект/Проблемы (подробно).md`
